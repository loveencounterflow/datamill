{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/document.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nGUY                       = require 'guy'\n{ alert\n  debug\n  help\n  info\n  plain\n  praise\n  urge\n  warn\n  whisper }               = GUY.trm.get_loggers 'DATAMILL/DOCUMENT'\n{ rpr\n  inspect\n  echo\n  log     }               = GUY.trm\ntypes                     = new ( require 'intertype' ).Intertype()\n{ isa\n  type_of }               = types\n{ SQL \n  sql }                   = require 'dbay'\n{ I, V, L, }              = sql\n#...........................................................................................................\n# FS                        = require 'node:fs'\nPATH                      = require 'node:path'\n{ get_base_types\n  get_document_types }      = require './types'\n\n\n#===========================================================================================================\n# DECORATORS\n#-----------------------------------------------------------------------------------------------------------\nclass Decorators\n  \n  ### NOTE this could meaningfully go into a static DBay submodule to assist in building client APIs ###\n\n  #---------------------------------------------------------------------------------------------------------\n  @get_all_first_values: ( table, field ) ->\n    -> @db.all_first_values SQL\"select #{I field} from #{I @cfg.prefix+table} order by 1;\"\n\n  #---------------------------------------------------------------------------------------------------------\n  @get_all_rows: ( table ) ->\n    -> @db.all_rows SQL\"select * from #{I @cfg.prefix+table} order by 1;\"\n\n#===========================================================================================================\nclass Document\n\n  #=========================================================================================================\n  # CONSTRUCTION\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    # super()\n    GUY.props.hide @, 'types', get_document_types()\n    @cfg        = @types.create.doc_document_cfg cfg\n    GUY.props.hide @, 'db',             @cfg.db;            delete @cfg.db\n    GUY.props.hide @, 'file_adapters',  @cfg.file_adapters; delete @cfg.file_adapters\n    @_procure_infrastructure()\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _procure_infrastructure: ->\n    ### TAINT skip if tables found ###\n    { prefix } = @cfg\n    @db.set_foreign_keys_state false\n    @db SQL\"\"\"\n      drop table if exists #{prefix}file;\"\"\"\n    @db.set_foreign_keys_state true\n    #-------------------------------------------------------------------------------------------------------\n    # TABLES\n    # #.......................................................................................................\n    # @db SQL\"\"\"\n    #   create table #{prefix}fads (\n    #       doc_fad_id            text not null,\n    #       doc_fad_name          text not null,\n    #       comment               text,\n    #     primary key ( doc_fad_id ) );\"\"\"\n    #.......................................................................................................\n    FS    = require 'node:fs'\n    PATH  = require 'node:path'\n    abspath_cfg =\n      name:           'abspath'\n      deterministic:  true\n      varargs:        false\n      call:           @get_doc_file_abspath.bind @\n    @db.create_function abspath_cfg\n    @db.alt.create_function abspath_cfg\n    #.......................................................................................................\n    @db SQL\"\"\"\n      create table #{prefix}files (\n          doc_file_id           text not null,\n          doc_file_path         text not null,\n          doc_file_hash         text,\n          doc_file_abspath      text not null generated always as ( abspath( doc_file_path ) ) virtual,\n          -- doc_fad_id            text not null references #{prefix}fads,\n          -- doc_file_parameters   json not null,\n        primary key ( doc_file_id ) );\"\"\"\n    #.......................................................................................................\n    @db.create_table_function\n      name:         \"lines_of\"\n      parameters:   [ 'doc_file_id', ]\n      columns:      [ 'doc_line_nr', 'doc_line_txt', ]\n      rows:         ( doc_file_abspath ) ->\n        doc_line_nr = 0\n        for doc_line_txt from GUY.fs.walk_lines doc_file_abspath\n          doc_line_nr++\n          yield { doc_line_nr, doc_line_txt, }\n        return null\n    #.......................................................................................................\n    @db SQL\"\"\"\n      create view #{prefix}lines as select\n          f.doc_file_id,\n          l.doc_line_nr,\n          l.doc_line_txt\n        from #{prefix}files             as f,\n        lines_of( f.doc_file_abspath )  as l\n        order by 1, 2;\"\"\"\n    #.......................................................................................................\n    @_insert_file     = @db.prepare_insert { into: \"#{prefix}files\", returning: '*', }\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  get_doc_file_abspath: ( doc_file_path ) -> PATH.resolve @cfg.home, doc_file_path\n\n  #---------------------------------------------------------------------------------------------------------\n  get_doc_file_ids:   Decorators.get_all_first_values 'files',      'doc_file_id'\n  # get_doc_fads:       Decorators.get_all_rows         'fads'\n\n  #---------------------------------------------------------------------------------------------------------\n  add_file: ( cfg ) ->\n    cfg = @types.create.doc_add_file_cfg cfg\n    { doc_file_id\n      doc_file_path\n      doc_file_hash } = cfg\n    doc_file_abspath  = @get_doc_file_abspath doc_file_path\n    doc_file_hash    ?= GUY.fs.get_content_hash doc_file_abspath, { fallback: null, }\n    return @db.first_row @_insert_file, { doc_file_id, doc_file_path, doc_file_hash, }\n\n\n#===========================================================================================================\n# FILE ADAPTERS (FADs)\n#===========================================================================================================\nclass File_adapter_abc\n  @comment: \"abstract base class for files\"\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ->\n    GUY.props.hide @, 'types', get_document_types()\n    return undefined\n\n\n# #===========================================================================================================\n# class External_file_abc extends File_adapter_abc\n#   @comment: \"abstract base class for external files\"\n\n#   #---------------------------------------------------------------------------------------------------------\n#   constructor: ( cfg ) ->\n#     super cfg\n#     @cfg   = @types.create.new_external_file_cfg cfg\n#     return undefined\n\n#   #---------------------------------------------------------------------------------------------------------\n#   write:        null\n#   walk_chunks:  null\n#   walk_lines:   null\n\n#===========================================================================================================\nclass External_text_file extends File_adapter_abc\n  @comment: \"adapter for external text files\"\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    super()\n    debug '^354^', { cfg, }\n    @cfg   = @types.create.new_external_text_file_cfg cfg\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  walk_lines: ->\n    yield 'helo'\n    yield 'world'\n    return null\n\n\n############################################################################################################\n### Abstract base classes use class name, instantiable classes short acronym with `x` meaning 'external',\n`txt` being most common file name extension for text files: ###\nfile_adapters   =\n  # File_adapter_abc:   File_adapter_abc\n  # External_file_abc:  External_file_abc\n  xtxt:               External_text_file\nmodule.exports  = { Document, File_adapter_abc, file_adapters, }\n\n\n\n\n\n"
  ]
}