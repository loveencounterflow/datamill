// Generated by CoffeeScript 2.4.1
(function() {
  'use strict';
  var $, $async, $watch, CND, H, Md, PD, TIMETUNNEL, VNR, assign, badge, debug, declare, echo, first, help, info, isa, jr, last, md, rpr, select, size_of, stamp, type_of, types, urge, validate, warn, whisper;

  //###########################################################################################################
  H = require('./helpers');

  CND = require('cnd');

  rpr = CND.rpr;

  badge = H.badge_from_filename(__filename);

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  info = CND.get_logger('info', badge);

  urge = CND.get_logger('urge', badge);

  help = CND.get_logger('help', badge);

  whisper = CND.get_logger('whisper', badge);

  echo = CND.echo.bind(CND);

  ({jr, assign} = CND);

  //...........................................................................................................
  require('./exception-handler');

  first = Symbol('first');

  last = Symbol('last');

  VNR = require('./vnr');

  //...........................................................................................................
  PD = require('pipedreams');

  ({$, $watch, $async, select, stamp} = PD);

  //...........................................................................................................
  types = require('./types');

  ({isa, validate, declare, size_of, type_of} = types);

  //...........................................................................................................
  Md = require('markdown-it');

  md = new Md();

  TIMETUNNEL = require('timetunnel');

  //-----------------------------------------------------------------------------------------------------------
  this.$consolidate_paragraphs = function(S) {
    var $vnr, collector, flush, send;
    collector = null;
    $vnr = null;
    send = null;
    //.........................................................................................................
    flush = function() {
      var text;
      if ((collector == null) || (collector.length === 0)) {
        return;
      }
      text = collector.join('\n');
      send(H.fresh_datom('^block', {text, $vnr}));
      collector = null;
      $vnr = null;
      return null;
    };
    //.........................................................................................................
    return $({last}, (d, send_) => {
      send = send_;
      if (d === last) {
        flush();
      } else if (select(d, '^line')) {
        if ($vnr == null) {
          $vnr = VNR.new_level(d.$vnr, 1);
        }
        if (collector == null) {
          collector = [];
        }
        collector.push(d.text);
        send(stamp(d));
      } else if (select(d, '^blank')) {
        flush();
        send(d);
      } else {
        send(d);
      }
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$parse = function(S) {
    var guards, intalph, tnl;
    guards = 'äöüßp';
    intalph = '0123456789';
    tnl = new TIMETUNNEL.Timetunnel({guards, intalph});
    // tnl.add_tunnel TIMETUNNEL.tunnels.remove_backslash
    // tnl.add_tunnel TIMETUNNEL.tunnels.keep_backslash
    tnl.add_tunnel(TIMETUNNEL.tunnels.htmlish);
    //.........................................................................................................
    return $((d, send) => {
      var $vnr, modified_text, original_text, text, tunneled_text;
      if (!(select(d, '^mktscript'))) {
        return send(d);
      }
      //.......................................................................................................
      original_text = d.text;
      tunneled_text = tnl.hide(original_text);
      modified_text = md.renderInline(tunneled_text);
      text = tnl.reveal(modified_text);
      // info 'µ33344', ( CND.white rpr text ), ( CND.yellow md.parse text )
      //.......................................................................................................
      info('µ33344', CND.white(jr(original_text)));
      info('µ33344', CND.red(jr(tunneled_text)));
      info('µ33344', CND.yellow(jr(modified_text)));
      info('µ33344', CND.green(jr(text)));
      info('µ33344');
      //.......................................................................................................
      send(stamp(d));
      $vnr = VNR.new_level(d.$vnr, 0);
      $vnr = VNR.advance($vnr);
      send(H.fresh_datom('^mktscript', {text, $vnr}));
      return send;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.repeat_phase = false;

  this.$transform = function(S) {
    var pipeline;
    pipeline = [];
    pipeline.push(this.$consolidate_paragraphs(S));
    pipeline.push(this.$parse(S));
    return PD.pull(...pipeline);
  };

}).call(this);

//# sourceMappingURL=040-markdown-inline.js.map
